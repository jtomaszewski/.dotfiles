#!/bin/bash

set -e

# Parse arguments
dry_run=false
force=false

for arg in "$@"; do
  case "$arg" in
    --dry-run|--dry)
      dry_run=true
      ;;
    --force)
      force=true
      ;;
    *)
      echo "Usage: git wclean [--dry-run|--dry] [--force]"
      echo "  --dry-run|--dry: Show what would be removed without making changes"
      echo "  --force: Force removal of worktrees (passed to git worktree remove)"
      exit 1
      ;;
  esac
done

repo_root=$(git rev-parse --show-toplevel)
current_dir=$(pwd)

# Get list of worktrees, skip the first line (header) and extract paths
worktrees=$(git worktree list --porcelain | grep '^worktree ' | cut -d' ' -f2-)

if [ -z "$worktrees" ]; then
  echo "âš ï¸ No worktrees found for this repo"
  exit 0
fi

if [[ "$dry_run" == true ]]; then
  echo "ğŸ” Dry run - showing what would be removed:"
else
  echo "ğŸ§¹ Cleaning worktrees"
fi

while IFS= read -r dir; do
  [ -n "$dir" ] || continue

  # Skip the main repo
  if [[ "$dir" == "$repo_root" ]]; then
    echo "â­ï¸ Skipping main worktree: $dir"
    continue
  fi

  # Skip if user is inside the worktree
  if [[ "$current_dir" == "$dir"* ]]; then
    echo "â­ï¸ Skipping current directory: $dir"
    continue
  fi

  if [[ "$dry_run" == true ]]; then
    if [[ "$force" == true ]]; then
      echo "ğŸ—‘ï¸ Would force remove worktree: $dir"
    else
      echo "ğŸ—‘ï¸ Would remove worktree: $dir"
    fi
  else
    if [[ "$force" == true ]]; then
      echo "ğŸ—‘ï¸ Force removing worktree: $dir"
      git worktree remove --force "$dir" || echo "âš ï¸ Failed to remove $dir"
    else
      echo "ğŸ—‘ï¸ Removing worktree: $dir"
      git worktree remove "$dir" || echo "âš ï¸ Failed to remove $dir"
    fi
  fi
done <<< "$worktrees"

if [[ "$dry_run" == true ]]; then
  echo "âœ… Dry run complete - no changes made"
else
  echo "âœ… Safe cleanup complete"
fi
